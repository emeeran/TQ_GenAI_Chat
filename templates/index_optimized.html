<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQ AI Chat</title>

    <!-- Preload critical assets for better performance -->
    {% if preload_assets %}
    {{ preload_assets(['js/app.js', 'js/core/api.js', 'js/core/ui.js', 'css/modular-ui.css']) | safe }}
    {% endif %}

    <!-- External fonts and libraries (preloaded) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&display=swap"
        rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Application CSS - Using asset loader -->
    {% if css_bundle %}
    {{ css_bundle() | safe }}
    {% else %}
    <!-- Fallback CSS -->
    <link rel="stylesheet" href="{{ asset_url('styles.css') }}">
    <link rel="stylesheet" href="{{ asset_url('css/modular-ui.css') }}">
    {% endif %}

    <!-- Code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ asset_url('favicon.ico') }}">

    <!-- Markdown support -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        marked.setOptions({
            gfm: true,
            breaks: true,
            headerIds: false,
            mangle: false
        });
    </script>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="sidebar-title">
                    <div class="sidebar-header d-flex align-items-center justify-content-center"
                        style="padding-top:0.7rem;padding-bottom:0.7rem;gap:0.7rem;">
                        <span style="font-weight:900;letter-spacing:0.04em;font-size:2.3rem;
                            font-family: 'Playfair Display', 'Georgia', 'Times New Roman', serif;
                            background: linear-gradient(90deg, #007cf0 0%, #00dfd8 100%);
                            background-clip: text;
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            text-shadow: 0 4px 16px rgba(0, 223, 216, 0.18), 0 1px 0 #fff;
                            margin-bottom:0;line-height:1.1;display:block;text-align:center;">AI Chatpal</span>
                    </div>
                </div>

                <!-- Model Settings -->
                <div class="settings-group" style="margin-bottom:0.5rem;">
                    <div class="settings-header" data-section="model" style="margin-bottom:0.08rem;">
                        <h4 style="margin-bottom:0.08rem;"><i class="fas fa-cog"></i> Model Settings</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="settings-content" id="model-settings" style="padding-bottom:0.08rem;">
                        <!-- Model Action Icons -->
                        <div class="model-actions mb-1" style="margin-bottom:0.12rem;">
                            <button class="btn btn-outline-secondary btn-sm" onclick="updateModelsFromProvider()"
                                id="update-models-btn" title="Update Models">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm ms-2" onclick="setDefaultModel()"
                                id="set-default-btn" title="Set Default Model">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-sm ms-2" onclick="setDefaultProvider()"
                                id="set-provider-btn" title="Set Global Default">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="btn btn-light btn-sm ms-2" onclick="toggleTheme()"
                                id="theme-toggle-btn-model" title="Toggle Theme"
                                style="box-shadow:none;border:none;background:transparent;">
                                <i class="fas fa-adjust"></i>
                            </button>
                        </div>
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <label for="provider" style="margin-bottom:0.03rem;">API Provider</label>
                            <select class="form-control" id="provider" onchange="updateModels()"
                                style="margin-bottom:0.03rem;">
                                <option value="cerebras">Cerebras</option>
                                <option value="groq">Groq</option>
                                <option value="openai">OpenAI</option>
                                <option value="mistral">Mistral</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="xai">X AI</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="gemini">Gemini</option>
                                <option value="cohere">Cohere</option>
                                <option value="alibaba">Alibaba</option>
                                <option value="openrouter">OpenRouter (Kimi)</option>
                                <option value="huggingface">Hugging Face</option>
                                <option value="moonshot">Moonshot</option>
                                <option value="perplexity">Perplexity</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <label for="model" style="margin-bottom:0.03rem;">Model</label>
                            <select class="form-control" id="model" disabled style="margin-bottom:0.03rem;">
                                <option value="">Select Model</option>
                            </select>
                        </div>
                        <!-- Removed persona settings to save space - moved to advanced settings -->
                        <!-- Temperature moved to advanced settings panel -->
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="settings-group" style="margin-bottom:0.5rem;">
                    <div class="settings-header" data-section="advanced" style="margin-bottom:0.08rem;">
                        <h4 style="margin-bottom:0.08rem;"><i class="fas fa-sliders-h"></i> Advanced</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="settings-content" id="advanced-settings" style="padding-bottom:0.08rem;">
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <label for="temperature" style="margin-bottom:0.03rem;">Temperature</label>
                            <div class="d-flex align-items-center gap-2" style="margin-bottom:0.03rem;">
                                <input type="range" class="form-range flex-grow-1" id="temperature" min="0" max="2"
                                    step="0.1" value="0.7">
                                <span class="text-muted" id="temperature-value">0.7</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <label for="persona" style="margin-bottom:0.03rem;">Persona</label>
                            <select class="form-control" id="persona" onchange="updatePersonaContent()"
                                style="margin-bottom:0.03rem;">
                                <option value="helpful_assistant" selected>Helpful Assistant</option>
                                <option value="code_expert">Code Expert</option>
                                <option value="medical_doctor">Medical Doctor</option>
                                <option value="pharmacist">Pharmacist</option>
                                <option value="psychologist">Psychologist</option>
                                <option value="business_analyst">Business Analyst</option>
                                <option value="legal_advisor">Legal Advisor</option>
                                <option value="tech_reviewer">Tech Reviewer</option>
                                <option value="authenticity_verifier">Authenticity Verifier</option>
                                <option value="research_scientist">Research Scientist</option>
                                <option value="custom">Custom Persona...</option>
                            </select>
                        </div>
                        <textarea class="form-control d-none" id="custom-persona-textarea" rows="3"
                            placeholder="Describe your custom persona..." onchange="updatePersonaContent()"
                            style="margin-bottom:0.03rem;"></textarea>
                        <div class="persona-content mt-2">
                            <small class="text-muted" id="persona-content" style="font-size:0.8em;">
                                <!-- Persona description will be loaded here -->
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Chat Settings -->
                <div class="settings-group" style="margin-bottom:0.5rem;">
                    <div class="settings-header" data-section="chat" style="margin-bottom:0.08rem;">
                        <h4 style="margin-bottom:0.08rem;"><i class="fas fa-comments"></i> Chat Options</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="settings-content" id="chat-settings" style="padding-bottom:0.08rem;">
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <button class="btn btn-warning btn-sm w-100" onclick="clearChat()"
                                title="Clear all messages" style="margin-bottom:0.03rem;">
                                <i class="fas fa-trash"></i> Clear Chat
                            </button>
                        </div>
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <button class="btn btn-info btn-sm w-100" onclick="exportChat()" title="Export chat as file"
                                style="margin-bottom:0.03rem;">
                                <i class="fas fa-download"></i> Export Chat
                            </button>
                        </div>
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <button class="btn btn-secondary btn-sm w-100" onclick="saveChat()"
                                title="Save current chat" style="margin-bottom:0.03rem;">
                                <i class="fas fa-save"></i> Save Chat
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="settings-group" style="margin-bottom:0.5rem;">
                    <div class="settings-header" data-section="voice" style="margin-bottom:0.08rem;">
                        <h4 style="margin-bottom:0.08rem;"><i class="fas fa-volume-up"></i> Voice</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="settings-content" id="voice-settings" style="padding-bottom:0.08rem;">
                        <div class="mb-3">
                            <label for="voice-select">Voice</label>
                            <select class="form-control" id="voice-select">
                                <option value="">Default</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="voice-rate">Rate</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range" class="form-range flex-grow-1" id="voice-rate" min="0.5" max="2"
                                    step="0.1" value="1">
                                <span class="text-muted" id="voice-rate-value">1.0x</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="voice-pitch">Pitch</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range" class="form-range flex-grow-1" id="voice-pitch" min="0.5" max="2"
                                    step="0.1" value="1">
                                <span class="text-muted" id="voice-pitch-value">1.0x</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Section -->
                <div id="status-container">
                    <div id="feedback" class="feedback-section mt-3 d-none">
                        <div class="d-flex justify-content-center">
                            <button class="btn btn-outline-success me-2" onclick="provideFeedback(true)">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="provideFeedback(false)">
                                <i class="fas fa-thumbs-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="col-md-9 chat-area">
                <div class="chat-box" id="chat-box"></div>
                <div class="input-container">
                    <button id="record-button" class="btn btn-primary" onclick="toggleRecording()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="attach-button" class="btn btn-secondary" title="Attach file"
                        onclick="document.getElementById('file-input').click();"
                        style="margin-left:0.3rem;margin-right:0.3rem;">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="file" id="file-input" style="display:none;" multiple
                        accept=".pdf,.epub,.jpg,.jpeg,.png,.docx,.xlsx,.csv,.txt,.md">
                    <div class="input-with-progress">
                        <input type="text" id="user-input" class="form-control" placeholder="Type your message...">
                        <div id="input-progress" class="input-progress d-none">
                            <div class="progress-spinner"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="sendMessage()" title="Send message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button id="speak-button" class="btn btn-primary" onclick="speakText(lastAiResponseText)"
                        title="Speak response">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button id="copy-response-btn" class="btn btn-outline-secondary d-none" onclick="copyLastResponse()"
                        title="Copy last response">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Critical JavaScript - Loaded first for immediate functionality -->
    {% if critical_js %}
    {{ critical_js() | safe }}
    {% else %}
    <!-- Fallback: Individual module loading -->
    {{ js_module('js/utils/helpers.js', critical=true) | safe }}
    {{ js_module('js/core/api.js', critical=true) | safe }}
    {{ js_module('js/core/ui.js', critical=true) | safe }}
    {{ js_module('js/app.js', critical=true) | safe }}
    {% endif %}

    <!-- Legacy compatibility functions (Phase 2 temporary - will be removed in Phase 3) -->
    <script>
        // Temporary bridge functions for existing HTML elements
        // These will be migrated to the new modular system

        function setDefaultModel() {
            if (window.app?.settings) {
                window.app.settings.updateSetting('defaultModel', document.getElementById('model').value);
            }
        }

        function setDefaultProvider() {
            const providerSelect = document.getElementById('provider');
            const selectedProvider = providerSelect.value;
            if (!selectedProvider) {
                alert('Please select a provider to set as global default.');
                return;
            }
            if (window.app?.settings) {
                window.app.settings.updateSetting('defaultProvider', selectedProvider);
                alert('Global default provider set to: ' + selectedProvider);
            } else {
                // Fallback to localStorage if app settings not available
                localStorage.setItem('defaultProvider', selectedProvider);
                alert('Global default provider set to: ' + selectedProvider);
            }
        }

        function toggleTheme() {
            if (window.app?.settings) {
                const current = window.app.settings.get('theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                window.app.settings.set('theme', newTheme);
            }
        }

        // Apply saved theme on load (fallback for before app initialization)
        document.addEventListener('DOMContentLoaded', function () {
            const savedTheme = localStorage.getItem('tq-genai-chat-settings');
            if (savedTheme) {
                try {
                    const settings = JSON.parse(savedTheme);
                    if (settings.theme) {
                        document.documentElement.setAttribute('data-theme', settings.theme);
                    }
                } catch (error) {
                    console.warn('Failed to load theme from settings:', error);
                }
            }
        });
    </script>

    <!-- Persona Management (temporary legacy support) -->
    <script>
        // Persona management - will be moved to ES6 modules in Phase 3
        let personaContents = {};

        function loadPersonas() {
            console.log('🔄 Loading personas...');
            const personaSelect = document.getElementById('persona');

            if (!personaSelect) {
                console.error('❌ Persona select element not found!');
                return;
            }

            // Set up persona contents
            window.personaContents = {
                'helpful_assistant': 'You are a friendly and knowledgeable AI assistant. Your responses should: - Explain concepts clearly and patiently - Use simple language for complex topics - Provide practical examples - Answer step-by-step - Stay focused and relevant - Be supportive and encouraging - Maintain a helpful tone - Suggest additional resources',
                'code_expert': 'You are a senior software developer. Your responses should: - Write clean, efficient code - Follow best practices - Include error handling - Provide documentation - Explain design choices - Consider performance - Include testing strategies - Suggest improvements',
                'medical_doctor': 'You are an experienced medical professional. Your responses should: - Explain medical concepts clearly - Use evidence-based information - Consider patient context - Explain preventive measures - Discuss treatment options - Reference medical research - Maintain professional tone - Focus on accurate information',
                'pharmacist': 'You are a professional pharmacist. Your responses should: - Provide pharmaceutical information - Explain medication usage and side effects - Advise on drug interactions - Emphasize safety and adherence - Reference clinical guidelines - Maintain a professional tone - Suggest consulting a healthcare provider for complex issues - Focus on patient well-being',
                'psychologist': 'You are a professional psychologist. Your responses should: - Explain psychological concepts - Use supportive language - Consider mental health aspects - Provide coping strategies - Reference research findings - Maintain boundaries - Focus on well-being - Suggest professional resources',
                'business_analyst': 'You are a skilled business analyst. Your responses should: - Analyze market trends - Provide data insights - Consider business context - Suggest strategies - Evaluate risks - Include metrics - Reference case studies - Focus on actionable insights',
                'legal_advisor': 'You are an experienced legal professional. Your responses should: - Explain legal concepts - Reference relevant laws - Consider jurisdictions - Explain implications - Suggest precautions - Maintain clarity - Include disclaimers - Focus on understanding',
                'tech_reviewer': 'You are a technology review specialist. Your responses should: - Analyze features - Compare alternatives - Consider use cases - Evaluate performance - Address limitations - Include benchmarks - Suggest configurations - Provide practical tips',
                'authenticity_verifier': 'You are an authenticity verification agent. Your responses should: - Fact-check information for accuracy - Validate sources and references - Detect potential misinformation or bias - Assess reliability and credibility - Highlight unsupported claims - Suggest reputable sources for confirmation - Maintain objectivity and transparency - Clearly indicate confidence in the information',
                'research_scientist': 'You are a research scientist. Your responses should: - Analyze methodology - Evaluate evidence - Explain findings - Consider limitations - Reference studies - Maintain objectivity - Include data analysis - Suggest further research'
            };

            console.log('✅ Personas loaded!');

            // Set up event listeners
            const customInput = document.getElementById('custom-persona-textarea');
            personaSelect.addEventListener('change', updatePersonaContent);
            if (customInput) customInput.addEventListener('input', updatePersonaContent);

            // Initial content update
            updatePersonaContent();
        }

        function updatePersonaContent() {
            const personaSelect = document.getElementById('persona');
            const customInput = document.getElementById('custom-persona-textarea');
            const contentDiv = document.getElementById('persona-content');
            const persona = personaSelect.value;

            if (persona === 'custom') {
                customInput.classList.remove('d-none');
                contentDiv.textContent = customInput.value || 'Describe your custom persona above.';
            } else {
                customInput.classList.add('d-none');
                customInput.value = '';
                contentDiv.textContent = personaContents[persona] || '';
            }
        }

        // Initialize personas when DOM is ready
        document.addEventListener('DOMContentLoaded', loadPersonas);
    </script>

    <!-- Provider/Model Management (temporary legacy support) -->
    <script>
        document.getElementById('provider')?.addEventListener('change', async function () {
            const modelSelect = document.getElementById('model');
            const provider = this.value;

            if (!provider) {
                modelSelect.disabled = true;
                modelSelect.innerHTML = '<option value="">Select Model</option>';
                return;
            }

            try {
                const response = await fetch(`/get_models/${provider}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        alert('Models endpoint not found.');
                    } else {
                        alert(`Error fetching models: ${response.status}`);
                    }
                    return;
                }

                const data = await response.json();
                modelSelect.innerHTML = '<option value="">Select Model</option>';

                if (data.models && Array.isArray(data.models)) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    modelSelect.disabled = false;
                } else {
                    console.error('Invalid models data received');
                }
            } catch (error) {
                console.error('Error fetching models:', error);
                alert('Failed to load models. Check network connection.');
            }
        });
    </script>
</body>

</html>