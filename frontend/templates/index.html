<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQ AI Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Initialize marked with options -->
    <script>
        marked.setOptions({
            gfm: true,
            breaks: true,
            headerIds: false,
            mangle: false
        });
    </script>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <div class="sidebar-title">
                    <div class="sidebar-header d-flex align-items-center justify-content-center"
                        style="padding-top:0.7rem;padding-bottom:0.7rem;gap:0.7rem;">
                        <span style="font-weight:900;letter-spacing:0.04em;font-size:2.3rem;
                            font-family: 'Playfair Display', 'Georgia', 'Times New Roman', serif;
                            background: linear-gradient(90deg, #007cf0 0%, #00dfd8 100%);
                            background-clip: text;
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            text-shadow: 0 4px 16px rgba(0, 223, 216, 0.18), 0 1px 0 #fff;
                            margin-bottom:0;line-height:1.1;display:block;text-align:center;">AI Chatpal</span>
                    </div>
                </div>

                <!-- Theme Toggle -->
                <!-- Theme Toggle moved to header -->
                <!-- Model Settings -->
                <div class="settings-group" style="margin-bottom:0.5rem;">
                    <div class="settings-header" data-section="model" style="margin-bottom:0.08rem;">
                        <h4 style="margin-bottom:0.08rem;"><i class="fas fa-cog"></i> Model Settings</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="settings-content" id="model-settings" style="padding-bottom:0.08rem;">
                        <!-- Model Action Icons -->
                        <div class="model-actions mb-1" style="margin-bottom:0.12rem;">
                            <button class="btn btn-outline-secondary btn-sm" onclick="updateModelsFromProvider()"
                                id="update-models-btn" title="Update Models">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm ms-2" onclick="setDefaultModel()"
                                id="set-default-btn" title="Set Default Model">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-sm ms-2" onclick="setDefaultProvider()"
                                id="set-provider-btn" title="Set Global Default">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="btn btn-light btn-sm ms-2" onclick="toggleTheme()"
                                id="theme-toggle-btn-model" title="Toggle Theme"
                                style="box-shadow:none;border:none;background:transparent;">
                                <i class="fas fa-adjust"></i>
                            </button>
                        </div>
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <label for="provider" style="margin-bottom:0.03rem;">API Provider</label>
                            <select class="form-control" id="provider" onchange="updateModels()"
                                style="margin-bottom:0.03rem;">
                                <option value="cerebras">Cerebras</option>
                                <option value="groq">Groq</option>
                                <option value="openai">OpenAI</option>
                                <option value="mistral">Mistral</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="xai">X AI</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="gemini">Gemini</option>
                                <option value="cohere">Cohere</option>
                                <option value="alibaba">Alibaba</option>
                                <option value="openrouter">OpenRouter (Kimi)</option>
                                <option value="huggingface">Hugging Face</option>
                                <option value="moonshot">Moonshot</option>
                                <option value="perplexity">Perplexity</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <label for="model" style="margin-bottom:0.03rem;">Model</label>
                            <select class="form-control" id="model" disabled style="margin-bottom:0.03rem;">
                                <option value="">Select Model</option>
                            </select>
                        </div>
                        <!-- Max Tokens Slider -->
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <div class="d-flex justify-content-between align-items-center"
                                style="margin-bottom:0.03rem;">
                                <label for="max-tokens">Max Tokens</label>
                                <span id="max-tokens-value" class="badge bg-secondary">4000</span>
                            </div>
                            <input type="range" class="form-range" id="max-tokens" min="1000" max="12000" step="500"
                                value="4000" style="margin-bottom:0.03rem;">
                        </div>
                        <!-- Temperature Slider -->
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <div class="d-flex justify-content-between align-items-center"
                                style="margin-bottom:0.03rem;">
                                <label for="temperature">Temperature</label>
                                <span id="temperature-value" class="badge bg-secondary">0.7</span>
                            </div>
                            <input type="range" class="form-range" id="temperature" min="0" max="1" step="0.1"
                                value="0.7" style="margin-bottom:0.03rem;">
                        </div>
                        <div class="form-group" style="margin-bottom:0.06rem;">
                            <label for="persona" style="margin-bottom:0.03rem;">Assistant Persona</label>
                            <select class="form-control" id="persona" style="margin-bottom:0.03rem;">
                                <!-- Persona options will be loaded dynamically -->
                            </select>
                            <textarea class="form-control mt-2 d-none" id="custom-persona-textarea"
                                placeholder="Enter your custom persona prompt..."
                                style="margin-bottom:0.03rem; min-height: 80px;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="settings-group">
                    <div class="settings-header active" data-section="actions">
                        <h4><i class="fas fa-tools"></i> Actions</h4>
                        <i class="fas fa-chevron-down" style="transform: rotate(180deg);"></i>
                    </div>
                    <div class="settings-content expanded" id="action-buttons" style="display: block;">
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-success w-100" onclick="saveChat()">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-warning w-100" onclick="retryLast()">
                                    <i class="fas fa-redo"></i> Retry
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-info w-100" onclick="loadSaved()">
                                    <i class="fas fa-folder-open"></i> Load
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-primary w-100" onclick="exportToMd()">
                                    <i class="fas fa-file-export"></i> Export
                                </button>
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <button class="btn btn-outline-danger w-100" onclick="window.location.href='/logout'">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-success w-100" onclick="resetChatUI()">
                                    <i class="fas fa-plus"></i> New
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="settings-group">
                    <div class="settings-header" data-section="voice">
                        <h4><i class="fas fa-microphone"></i> Audio Settings</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="settings-content" id="voice-settings">
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto-speak" checked>
                                <label class="form-check-label" for="auto-speak">
                                    Auto-speak responses
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="voice-language">Output Response Language</label>
                            <select class="form-control" id="voice-language">
                                <option value="en">English</option>
                                <option value="ta">Tamil</option>
                                <option value="hi">Hindi</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="zh">Chinese</option>
                                <option value="ar">Arabic</option>
                                <option value="ru">Russian</option>
                                <option value="ja">Japanese</option>
                                <option value="pt">Portuguese</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="voice-gender">Voice Gender</label>
                            <select class="form-control" id="voice-gender">
                                <option value="all">All</option>
                                <option value="female">Female</option>
                                <option value="male">Male</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="voice-select">Voice Selection</label>
                            <select class="form-control" id="voice-select">
                                <option value="">Loading voices...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="voice-rate">Speed</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range" class="form-range flex-grow-1" id="voice-rate" min="0.5" max="2"
                                    step="0.1" value="1">
                                <span class="text-muted" id="voice-rate-value">1.0x</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="voice-pitch">Pitch</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range" class="form-range flex-grow-1" id="voice-pitch" min="0.5" max="2"
                                    step="0.1" value="1">
                                <span class="text-muted" id="voice-pitch-value">1.0x</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Move File Upload section here, after Voice Settings -->
                <!-- Removed Files section from sidebar as requested -->

                <!-- Add this button after the upload section -->
                <!-- Removed sidebar file list button as requested -->

                <!-- Status Section -->
                <div id="status-container">
                    <div id="feedback" class="feedback-section mt-3 d-none">
                        <div class="d-flex justify-content-center">
                            <button class="btn btn-outline-success me-2" onclick="provideFeedback(true)">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="provideFeedback(false)">
                                <i class="fas fa-thumbs-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Chat Area -->
            <div class="col-md-9 chat-area">
                <div class="chat-box" id="chat-box"></div>
                <div class="input-container">
                    <button id="record-button" class="btn btn-primary" onclick="toggleRecording()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="attach-button" class="btn btn-secondary" title="Attach file"
                        onclick="document.getElementById('file-input').click();"
                        style="margin-left:0.3rem;margin-right:0.3rem;">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="file" id="file-input" style="display:none;" multiple
                        accept=".pdf,.epub,.jpg,.jpeg,.png,.docx,.xlsx,.csv,.txt,.md">
                    <div class="input-with-progress">
                        <input type="text" id="user-input" class="form-control" placeholder="Type your message...">
                        <div id="input-progress" class="input-progress d-none">
                            <div class="progress-spinner"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="sendMessage()" title="Send message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button id="speak-button" class="btn btn-primary" onclick="speakText(lastAiResponseText)"
                        title="Speak response">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button id="copy-response-btn" class="btn btn-outline-secondary d-none" onclick="copyLastResponse()"
                        title="Copy last response">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Removed file list modal as requested -->

    <script src="/static/script.js"></script>
    <script>
        function resetChatUI() {
            // Clear chat box
            const chatBox = document.getElementById('chat-box');
            if (chatBox) chatBox.innerHTML = '';

            // Clear user input
            const userInput = document.getElementById('user-input');
            if (userInput) userInput.value = '';

            // Reset provider/model/persona dropdowns
            const provider = document.getElementById('provider');
            if (provider) provider.selectedIndex = 0;
            const model = document.getElementById('model');
            if (model) {
                model.innerHTML = '<option value="">Select Model</option>';
                model.disabled = true;
            }
            const persona = document.getElementById('persona');
            if (persona) persona.selectedIndex = 0;
            const customPersona = document.getElementById('custom-persona-textarea');
            if (customPersona) {
                customPersona.value = '';
                customPersona.classList.add('d-none');
            }

            // Reset sliders
            const maxTokens = document.getElementById('max-tokens');
            if (maxTokens) {
                maxTokens.value = 4000;
                document.getElementById('max-tokens-value').textContent = '4000';
            }
            const temperature = document.getElementById('temperature');
            if (temperature) {
                temperature.value = 0.7;
                document.getElementById('temperature-value').textContent = '0.7';
            }

            // Reset voice settings
            const voiceLang = document.getElementById('voice-language');
            if (voiceLang) voiceLang.selectedIndex = 0;
            const voiceGender = document.getElementById('voice-gender');
            if (voiceGender) voiceGender.selectedIndex = 0;
            const voiceSelect = document.getElementById('voice-select');
            if (voiceSelect) voiceSelect.selectedIndex = 0;
            const voiceRate = document.getElementById('voice-rate');
            if (voiceRate) {
                voiceRate.value = 1;
                document.getElementById('voice-rate-value').textContent = '1.0x';
            }
            const voicePitch = document.getElementById('voice-pitch');
            if (voicePitch) {
                voicePitch.value = 1;
                document.getElementById('voice-pitch-value').textContent = '1.0x';
            }

            // Hide feedback and copy buttons
            const feedback = document.getElementById('feedback');
            if (feedback) feedback.classList.add('d-none');
            const copyBtn = document.getElementById('copy-response-btn');
            if (copyBtn) copyBtn.classList.add('d-none');

            // Reset any other UI state as needed
        }
    </script>
    <script>
        function setDefaultModel() {
            const modelSelect = document.getElementById('model');
            const selectedModel = modelSelect.value;
            if (!selectedModel) {
                alert('Please select a model to set as default.');
                return;
            }
            // Save to localStorage or send to backend as needed
            localStorage.setItem('defaultModel', selectedModel);
            alert('Default model set to: ' + selectedModel);
        }

        function setDefaultProvider() {
            const providerSelect = document.getElementById('provider');
            const selectedProvider = providerSelect.value;
            if (!selectedProvider) {
                alert('Please select a provider to set as global default.');
                return;
            }
            // Save to localStorage - this will persist until reset
            localStorage.setItem('defaultProvider', selectedProvider);
            alert('Global default provider set to: ' + selectedProvider);
        }

        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('theme-dark')) {
                body.classList.remove('theme-dark');
                body.classList.add('theme-light');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('theme-light');
                body.classList.add('theme-dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // On page load, apply saved theme
        document.addEventListener('DOMContentLoaded', function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('theme-dark');
            } else {
                document.body.classList.add('theme-light');
            }
        });
    </script>
    <script>
        // Dynamically load personas from backend and update dropdown and description
        let personaContents = {};
        function loadPersonas() {
            console.log('🔄 Starting loadPersonas function...');
            const personaSelect = document.getElementById('persona');
            if (!personaSelect) {
                console.error('❌ Persona select element not found!');
                return;
            }
            // Fetch personas from backend
            fetch('/get_personas')
                .then(response => response.json())
                .then(data => {
                    const personas = data.personas || [];
                    let optionsHtml = '';
                    window.personaContents = {};
                    personas.forEach(p => {
                        optionsHtml += `<option value="${p.id}">${p.name}</option>`;
                        window.personaContents[p.id] = p.content;
                    });
                    optionsHtml += '<option value="custom">Custom Persona...</option>';
                    personaSelect.innerHTML = optionsHtml;
                    personaSelect.selectedIndex = 0;
                    updatePersonaContent();
                    console.log('✅ Personas loaded from backend! Total options:', personaSelect.options.length);
                })
                .catch(err => {
                    console.error('❌ Failed to load personas from backend:', err);
                });
            // Set up event listeners
            const customInput = document.getElementById('custom-persona-textarea');
            personaSelect.addEventListener('change', updatePersonaContent);
            if (customInput) customInput.addEventListener('input', updatePersonaContent);
        }

        function updatePersonaContent() {
            const personaSelect = document.getElementById('persona');
            const customInput = document.getElementById('custom-persona-textarea');
            const contentDiv = document.getElementById('persona-content');
            let persona = personaSelect.value;
            if (persona === 'custom') {
                customInput.classList.remove('d-none');
                contentDiv.textContent = customInput.value || 'Describe your custom persona above.';
            } else {
                customInput.classList.add('d-none');
                customInput.value = '';
                contentDiv.textContent = personaContents[persona] || '';
            }
        }

        document.addEventListener('DOMContentLoaded', loadPersonas);
    </script>
    <script>
        document.getElementById('provider').addEventListener('change', async function () {
            const modelSelect = document.getElementById('model');
            const provider = this.value;

            if (!provider) {
                modelSelect.disabled = true;
                modelSelect.innerHTML = '<option value="">Select Model</option>';
                return;
            }

            try {
                const response = await fetch(`/get_models/${provider}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        alert('Model list not found for this provider (404).');
                    } else if (response.status === 400) {
                        alert('Bad request for model list (400).');
                    } else if (response.status === 304) {
                        alert('Model list not modified (304). Try refreshing.');
                    } else {
                        alert(`Error fetching models: ${response.status}`);
                    }
                    modelSelect.disabled = true;
                    modelSelect.innerHTML = '<option value="">Select Model</option>';
                    return;
                }
                const models = await response.json();

                modelSelect.innerHTML = '<option value="">Select Model</option>';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });

                modelSelect.disabled = false;
            } catch (error) {
                alert('Network or server error fetching models.');
                console.error('Error fetching models:', error);
            }
        });

        const sendMessage = async () => {
            const message = document.getElementById('user-input').value;
            const provider = document.getElementById('provider').value;
            const model = document.getElementById('model').value;

            if (!message || !provider || !model) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        provider: provider,
                        model: model
                    })
                });
                if (!response.ok) {
                    if (response.status === 404) {
                        alert('Chat endpoint not found (404).');
                    } else if (response.status === 400) {
                        alert('Bad request to chat endpoint (400).');
                    } else if (response.status === 304) {
                        alert('Chat response not modified (304). Try refreshing.');
                    } else {
                        alert(`Error sending message: ${response.status}`);
                    }
                    return;
                }
                // ...handle response as needed...
            } catch (error) {
                alert('Network or server error sending message.');
                console.error('Error sending message:', error);
            }
        };
    </script>
</body>

</html>